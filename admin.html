<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – TrueTier</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <style>
    :root {
      --bg: #050508;
      --bg-card: #0c0b10;
      --border: #1e1c28;
      --accent: #ff4655;
      --accent-hover: #ff5c6a;
      --text: #f4f3f8;
      --text-muted: #8c8898;
      --radius: 12px;
      --radius-pill: 999px;
      --ease-out: cubic-bezier(0.22, 1, 0.36, 1);
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); min-height: 100vh; color: var(--text); }
    .gate-screen, .auth-screen, .panel-screen { display: none; padding: 2rem; max-width: 480px; margin: 0 auto; text-align: center; }
    .gate-screen.show, .auth-screen.show, .panel-screen.show { display: block; animation: fadeIn 0.4s var(--ease-out); }
    .gate-screen h2, .auth-screen h2 { color: var(--accent); margin-bottom: 0.5rem; font-weight: 700; }
    .gate-screen p, .auth-screen p { color: var(--text-muted); }
    .back-home {
      display: inline-block;
      margin-top: 1.25rem;
      padding: 0.6rem 1.2rem;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      transition: all 0.25s var(--ease-out);
    }
    .back-home:hover { color: var(--accent); border-color: var(--accent); background: rgba(255, 70, 85, 0.1); transform: translateY(-1px); }
    .panel-screen .back-home { margin-top: 0; margin-bottom: 1rem; }
    .auth-screen input {
      width: 100%;
      padding: 0.8rem 1rem;
      margin-bottom: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .auth-screen input:focus { outline: none; border-color: var(--accent); }
    .auth-screen button {
      width: 100%;
      padding: 0.85rem;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-pill);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.25s var(--ease-out);
    }
    .auth-screen button:hover { background: var(--accent-hover); transform: translateY(-1px); }
    .panel-screen { max-width: 900px; text-align: left; }
    .panel-screen h1 { font-size: 1.6rem; margin-bottom: 1rem; color: var(--accent); font-weight: 700; letter-spacing: -0.02em; }
    .admin-status-bar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding: 0.75rem 1.25rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      animation: fadeInUp 0.4s var(--ease-out);
    }
    .admin-status-bar label { margin: 0; display: inline; font-size: 0.9rem; color: var(--text-muted); }
    .admin-status-bar select {
      padding: 0.5rem 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      color: var(--text);
      font-family: inherit;
      font-size: 0.9rem;
    }
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .tabs button {
      padding: 0.65rem 1.2rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      color: var(--text-muted);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.25s var(--ease-out);
    }
    .tabs button:hover { color: var(--text); border-color: rgba(255,70,85,0.4); }
    .tabs button.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; animation: fadeInUp 0.35s var(--ease-out); }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.35rem;
      margin-bottom: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .card:hover { border-color: rgba(255,70,85,0.2); }
    .card h3 { font-size: 1.05rem; margin-bottom: 0.75rem; color: var(--text); font-weight: 600; }
    .card label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .card input, .card textarea {
      width: 100%;
      padding: 0.65rem 1rem;
      margin-bottom: 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: inherit;
    }
    .card input:focus, .card textarea:focus { outline: none; border-color: var(--accent); }
    .card textarea { min-height: 80px; resize: vertical; }
    .card button {
      padding: 0.6rem 1.2rem;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-pill);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      transition: all 0.25s var(--ease-out);
    }
    .card button:hover { transform: translateY(-1px); }
    .card button.secondary { background: var(--border); color: var(--text); }
    .card button.secondary:hover { background: #2a2830; }
    .card button.primary { background: var(--accent); color: #fff; }
    .card button.primary:hover { background: var(--accent-hover); }
    .card button.danger { background: #dc2626; color: #fff; }
    .card button.danger:hover { background: #b91c1c; }
    .file-input { position: absolute; width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; z-index: -1; }
    .file-btn-wrap { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .user-row, .ticket-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    .user-row.banned { border-color: var(--accent); opacity: 0.85; }
    .user-info, .ticket-info { font-size: 0.9rem; }
    .user-info strong, .ticket-info strong { color: var(--accent); }
    .user-actions, .ticket-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .ticket-detail {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 8px;
      border-left: 3px solid var(--accent);
    }
    .ticket-detail .reply { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); font-size: 0.9rem; }
    .ticket-detail .reply.admin { border-left: 3px solid var(--accent); padding-left: 0.75rem; }
    .ticket-detail textarea { margin-top: 0.5rem; min-height: 60px; }
    .ticket-user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      margin-bottom: 1rem;
      background: var(--bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .ticket-user-profile img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    .ticket-user-profile .profile-info { font-size: 0.9rem; }
    .ticket-user-profile .profile-info strong { display: block; color: var(--accent); }
    .ticket-attachments { margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .ticket-attachments img { max-width: 100px; max-height: 100px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border); }
    .loading { color: var(--text-muted); }
    .card.expired-ann { opacity: 0.65; }
    .err { color: var(--accent); font-size: 0.9rem; margin-top: 0.5rem; line-height: 1.5; max-width: 100%; }
    .err strong { color: var(--text); }
  </style>
</head>
<body>
  <div class="gate-screen" id="gateScreen">
    <h2>Access denied</h2>
    <p>This page is only accessible from an authorized network.</p>
    <a href="/" class="back-home">← Back to home</a>
  </div>
  <div class="auth-screen" id="authScreen">
    <h2>Admin login</h2>
    <p style="margin-bottom:1rem;">Sign in with your admin account.</p>
    <input type="text" id="adminEmail" placeholder="Username" value="admin" autocomplete="username">
    <input type="password" id="adminPass" placeholder="Password" value="password" autocomplete="current-password">
    <button type="button" id="adminLogin">Log in</button>
    <p class="err" id="authErr"></p>
    <a href="/" class="back-home">← Back to home</a>
  </div>
  <div class="panel-screen" id="panelScreen">
    <a href="/" class="back-home">← Back to home</a>
    <h1>Admin panel</h1>
    <div class="tabs">
      <button type="button" data-tab="announcements">Announcements</button>
      <button type="button" data-tab="users">Users</button>
      <button type="button" data-tab="tickets">Tickets</button>
      <button type="button" data-tab="chats">Chats</button>
    </div>
    <div class="admin-status-bar">
      <label>Your status:</label>
      <select id="adminStatus">
        <option value="online">Online</option>
        <option value="away">Away</option>
        <option value="dnd">Do Not Disturb</option>
      </select>
    </div>
    <div id="tabAnnouncements" class="tab-panel">
      <div class="card">
        <h3>New announcement</h3>
        <label>Title</label>
        <input type="text" id="annTitle" placeholder="Title">
        <label>Body</label>
        <textarea id="annBody" placeholder="Message..."></textarea>
        <label>Show for</label>
        <select id="annDuration">
          <option value="24">24 hours</option>
          <option value="72">3 days</option>
          <option value="168" selected>7 days</option>
          <option value="720">30 days</option>
          <option value="-1">Forever</option>
        </select>
        <input type="hidden" id="annEditId" value="">
        <button type="button" id="annSubmit">Publish</button>
        <button type="button" id="annCancelEdit" class="secondary" style="display:none;">Cancel edit</button>
      </div>
      <div id="annList"></div>
    </div>
    <div id="tabUsers" class="tab-panel">
      <p class="loading" id="usersList">Loading users…</p>
    </div>
    <div id="tabTickets" class="tab-panel">
      <p class="loading" id="ticketsList">Loading tickets…</p>
    </div>
    <div id="tabChats" class="tab-panel">
      <p class="loading" id="chatsList">Loading chats…</p>
    </div>
  </div>

  <script>
    var ALLOWED_IP = '172.56.25.44'; // Admin login: create Firebase user email admin@truetier.com, password password. IP verified after sign-in.
    const firebaseConfig = {
      apiKey: "AIzaSyA8Ir6slVIVLH2ax4Ypd7mgowhIXIl_Qhk",
      authDomain: "truetier-9567f.firebaseapp.com",
      databaseURL: "https://truetier-9567f-default-rtdb.firebaseio.com",
      projectId: "truetier-9567f",
      storageBucket: "truetier-9567f.firebasestorage.app",
      messagingSenderId: "112020148911",
      appId: "1:112020148911:web:ca2338326009d12656ba5a"
    };

    function show(el) { document.querySelectorAll('.gate-screen, .auth-screen, .panel-screen').forEach(function(e) { e.classList.remove('show'); }); el.classList.add('show'); }

    function checkIp() {
      var req = new XMLHttpRequest();
      req.open('GET', 'https://api.ipify.org?format=json');
      req.onload = function() {
        try {
          var ip = JSON.parse(req.responseText).ip;
          if (ip === ALLOWED_IP) {
            show(document.getElementById('authScreen'));
            initFirebase();
          } else {
            show(document.getElementById('gateScreen'));
          }
        } catch (e) {
          show(document.getElementById('gateScreen'));
        }
      };
      req.onerror = function() { show(document.getElementById('gateScreen')); };
      req.send();
    }

    function initFirebase() {
      firebase.initializeApp(firebaseConfig);
      var auth = firebase.auth();
      var db = firebase.database();

      auth.onAuthStateChanged(function(user) {
        if (!user) {
          show(document.getElementById('authScreen'));
          return;
        }
        var email = (user.email || '').toLowerCase();
        if (email !== 'admin@truetier.com') {
          document.getElementById('authErr').textContent = 'Not an admin account.';
          auth.signOut();
          show(document.getElementById('authScreen'));
          return;
        }
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://api.ipify.org?format=json');
        xhr.onload = function() {
          try {
            var ip = JSON.parse(xhr.responseText).ip;
            if (ip !== ALLOWED_IP) {
              auth.signOut();
              document.getElementById('authErr').textContent = 'Access denied. You must be on the authorized network (IP: ' + ALLOWED_IP + ').';
              show(document.getElementById('authScreen'));
              return;
            }
            show(document.getElementById('panelScreen'));
            runAdminPanel(auth, firebase.database(), firebase.storage());
          } catch (e) {
            auth.signOut();
            document.getElementById('authErr').textContent = 'Could not verify network.';
            show(document.getElementById('authScreen'));
          }
        };
        xhr.onerror = function() {
          auth.signOut();
          document.getElementById('authErr').textContent = 'Could not verify network.';
          show(document.getElementById('authScreen'));
        };
        xhr.send();
      });

      document.getElementById('adminLogin').onclick = function() {
        var err = document.getElementById('authErr');
        err.textContent = '';
        var rawEmail = document.getElementById('adminEmail').value.trim();
        var email = (rawEmail === 'admin' || rawEmail.indexOf('@') === -1) ? 'admin@truetier.com' : rawEmail;
        var password = document.getElementById('adminPass').value;
        auth.signInWithEmailAndPassword(email, password).catch(function(e) {
          var code = (e && e.code) ? e.code : '';
          if (code === 'auth/invalid-credential' || code === 'auth/wrong-password' || code === 'auth/user-not-found') {
            err.innerHTML = 'No admin account found. In Firebase Console go to <strong>Authentication → Users → Add user</strong> and create a user with email <strong>admin@truetier.com</strong> and password <strong>password</strong>, then try again.';
          } else {
            err.textContent = e.message || 'Login failed.';
          }
        });
      };
    }

    function runAdminPanel(auth, db, storage) {
      document.querySelectorAll('.tabs button').forEach(function(btn) {
        btn.onclick = function() {
          document.querySelectorAll('.tabs button').forEach(function(b) { b.classList.remove('active'); });
          document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
          btn.classList.add('active');
          var tab = btn.getAttribute('data-tab');
          document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        };
      });
      document.querySelector('.tabs button').click();

      function annExpiresAt(durationHours) {
        if (durationHours === -1 || durationHours == null) return null;
        return Date.now() + durationHours * 60 * 60 * 1000;
      }
      document.getElementById('annSubmit').onclick = function() {
        var title = document.getElementById('annTitle').value.trim();
        var body = document.getElementById('annBody').value.trim();
        var duration = parseInt(document.getElementById('annDuration').value, 10);
        var editId = document.getElementById('annEditId').value;
        if (!title || !body) return;
        var data = {
          title: title,
          body: body,
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          createdBy: auth.currentUser.uid,
          expiresAt: annExpiresAt(duration) || null
        };
        if (editId) {
          db.ref('announcements/' + editId).update({
            title: title,
            body: body,
            expiresAt: annExpiresAt(duration) || null
          }).then(function() {
            document.getElementById('annTitle').value = '';
            document.getElementById('annBody').value = '';
            document.getElementById('annEditId').value = '';
            document.getElementById('annCancelEdit').style.display = 'none';
          });
        } else {
          db.ref('announcements').push(data).then(function() {
            document.getElementById('annTitle').value = '';
            document.getElementById('annBody').value = '';
          });
        }
      };
      document.getElementById('annCancelEdit').onclick = function() {
        document.getElementById('annTitle').value = '';
        document.getElementById('annBody').value = '';
        document.getElementById('annEditId').value = '';
        this.style.display = 'none';
      };

      db.ref('announcements').orderByChild('createdAt').limitToLast(50).on('value', function(snap) {
        var listEl = document.getElementById('annList');
        var items = [];
        snap.forEach(function(c) {
          var v = c.val();
          items.push({ id: c.key, title: v.title || '', body: v.body || '', expiresAt: v.expiresAt || null, createdAt: v.createdAt });
        });
        items.reverse();
        if (items.length === 0) {
          listEl.innerHTML = '<p class="loading">No announcements.</p>';
          return;
        }
        var now = Date.now();
        var html = '';
        items.forEach(function(a) {
          var expired = a.expiresAt != null && a.expiresAt < now;
          var expText = a.expiresAt == null ? 'Forever' : (expired ? 'Expired' : 'Expires ' + new Date(a.expiresAt).toLocaleDateString());
          html += '<div class="card' + (expired ? ' expired-ann' : '') + '" data-ann-id="' + escapeHtml(a.id) + '">' +
            '<h3>' + escapeHtml(a.title) + '</h3>' +
            '<p style="color:var(--text-muted);font-size:0.9rem;" class="ann-body-p">' + escapeHtml(a.body) + '</p>' +
            '<p style="font-size:0.8rem;color:var(--text-muted);margin-top:0.5rem;">' + expText + '</p>' +
            '<div style="margin-top:0.75rem;display:flex;gap:0.5rem;">' +
            '<button type="button" class="secondary ann-edit-btn">Edit</button>' +
            '<button type="button" class="danger ann-del-btn">Delete</button></div></div>';
        });
        listEl.innerHTML = html;
        listEl.querySelectorAll('.ann-edit-btn').forEach(function(btn) {
          var card = btn.closest('.card');
          var id = card.getAttribute('data-ann-id');
          var title = card.querySelector('h3').textContent;
          var body = card.querySelector('.ann-body-p').textContent;
          btn.onclick = function() {
            document.getElementById('annTitle').value = title;
            document.getElementById('annBody').value = body;
            document.getElementById('annEditId').value = id;
            document.getElementById('annCancelEdit').style.display = 'inline-block';
          };
        });
        listEl.querySelectorAll('.ann-del-btn').forEach(function(btn) {
          var id = btn.closest('.card').getAttribute('data-ann-id');
          btn.onclick = function() {
            if (!confirm('Delete this announcement?')) return;
            db.ref('announcements/' + id).remove();
          };
        });
      });

      function loadUsers() {
        var listEl = document.getElementById('usersList');
        listEl.innerHTML = '<p class="loading">Loading users…</p>';
        db.ref('users').once('value').then(function(snap) {
          if (!snap || !snap.numChildren()) {
            listEl.innerHTML = '<p class="loading">No users.</p>';
            return;
          }
          listEl.innerHTML = '';
          snap.forEach(function(c) {
            var v = c.val();
            var uid = c.key;
            db.ref('bannedUsers/' + uid).once('value').then(function(banSnap) {
              var banned = banSnap.exists();
              var row = document.createElement('div');
              row.className = 'user-row' + (banned ? ' banned' : '');
              var hasCustomer = v.badges && v.badges.customer;
              row.innerHTML =
                '<div class="user-info">' +
                  '<strong>' + escapeHtml(v.displayName || v.email || uid) + '</strong><br>' +
                  (v.email ? escapeHtml(v.email) + '<br>' : '') +
                  (v.valorantName ? 'Valorant: ' + escapeHtml(v.valorantName) : '') +
                '</div>' +
                '<div class="user-actions">' +
                  (banned
                    ? '<button type="button" class="secondary unban-btn" data-uid="' + uid + '">Unban</button>'
                    : '<button type="button" class="danger ban-btn" data-uid="' + uid + '">Ban</button>') +
                  (hasCustomer
                    ? '<button type="button" class="secondary customer-btn" data-uid="' + uid + '" title="Revoke customer badge">Revoke customer</button>'
                    : '<button type="button" class="secondary customer-btn" data-uid="' + uid + '" title="Grant customer badge">Grant customer</button>') +
                  '<button type="button" class="secondary edit-btn" data-uid="' + uid + '" data-name="' + escapeHtml(v.displayName || '') + '" data-valorant="' + escapeHtml(v.valorantName || '') + '">Edit</button>' +
                '</div>';
              listEl.appendChild(row);
            });
          });
        }).catch(function(e) {
          listEl.innerHTML = '<p class="err">Error loading users: ' + (e.message || 'Permission denied') + '. Update Firebase rules (see FIREBASE_RULES.md).</p>';
        });
      }
      loadUsers();

      document.getElementById('usersList').addEventListener('click', function(e) {
        var uid = e.target.getAttribute('data-uid');
        if (!uid) return;
        if (e.target.classList.contains('ban-btn')) {
          db.ref('bannedUsers/' + uid).set({ reason: 'Banned by admin', at: firebase.database.ServerValue.TIMESTAMP }).then(function() {
            document.getElementById('usersList').innerHTML = 'Loading users…';
            loadUsers();
          });
        } else if (e.target.classList.contains('unban-btn')) {
          db.ref('bannedUsers/' + uid).remove().then(function() {
            document.getElementById('usersList').innerHTML = 'Loading users…';
            loadUsers();
          });
        } else if (e.target.classList.contains('edit-btn')) {
          var name = prompt('Display name', e.target.getAttribute('data-name') || '');
          if (name === null) return;
          var valorant = prompt('Valorant name', e.target.getAttribute('data-valorant') || '');
          if (valorant === null) return;
          var up = {};
          if (name !== '') up.displayName = name;
          if (valorant !== '') up.valorantName = valorant;
          db.ref('users/' + uid).update(up);
        } else if (e.target.classList.contains('customer-btn')) {
          db.ref('users/' + uid + '/badges/customer').once('value', function(s) {
            var grant = !s.val();
            db.ref('users/' + uid + '/badges/customer').set(grant ? true : null).then(function() {
              loadUsers();
            });
          });
        }
      });

      document.getElementById('adminStatus').onchange = function() {
        var status = this.value;
        db.ref('admin/status/' + auth.currentUser.uid).set(status);
      };
      db.ref('admin/status/' + auth.currentUser.uid).on('value', function(s) {
        var v = s.val();
        if (v) document.getElementById('adminStatus').value = v;
      });

      db.ref('chats').on('value', function(snap) {
        var list = document.getElementById('chatsList');
        list.innerHTML = '';
        var chats = [];
        snap.forEach(function(c) { chats.push({ id: c.key, v: c.val() }); });
        chats.forEach(function(ch) {
          var v = ch.v;
          var customerId = ch.id;
          var div = document.createElement('div');
          div.className = 'card';
          div.innerHTML =
            '<div class="ticket-row">' +
              '<div class="ticket-info"><strong>Chat with customer ' + escapeHtml(customerId) + '</strong></div>' +
            '</div>' +
            '<div class="ticket-detail">' +
              '<div class="chat-messages" data-cid="' + ch.id + '"></div>' +
              '<textarea placeholder="Reply..." class="chat-reply" data-cid="' + ch.id + '"></textarea>' +
              '<button type="button" class="reply-btn primary chat-send-btn" data-cid="' + ch.id + '">Send</button>' +
            '</div>';
          list.appendChild(div);
          var msgEl = div.querySelector('.chat-messages');
          var msgs = v.messages || {};
          var keys = Object.keys(msgs).sort(function(a,b) { return (msgs[a].createdAt || 0) - (msgs[b].createdAt || 0); });
          keys.forEach(function(k) {
            var m = msgs[k];
            var p = document.createElement('p');
            p.className = 'reply ' + (m.isAdmin ? 'admin' : '');
            p.textContent = (m.displayName || (m.isAdmin ? 'Admin' : 'User')) + ': ' + (m.text || '');
            msgEl.appendChild(p);
          });
        });
        if (chats.length === 0) list.innerHTML = '<p class="loading">No chats yet.</p>';
        list.querySelectorAll('.chat-send-btn').forEach(function(btn) {
          btn.onclick = function() {
            var cid = btn.getAttribute('data-cid');
            var textarea = list.querySelector('.chat-reply[data-cid="' + cid + '"]');
            var msg = textarea.value.trim();
            if (!msg) return;
            db.ref('chats/' + cid + '/messages').push({
              text: msg,
              isAdmin: true,
              displayName: 'Admin',
              createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(function() {
              db.ref('chats/' + cid).update({ updatedAt: firebase.database.ServerValue.TIMESTAMP });
              textarea.value = '';
            });
          };
        });
      });

      function replyAttachmentsHtml(arr) {
        if (!arr || !arr.length) return '';
        return '<div class="ticket-attachments">' + arr.map(function(a) {
          return '<a href="' + escapeHtml(a.url) + '" target="_blank" rel="noopener"><img src="' + escapeHtml(a.url) + '" alt=""></a>';
        }).join('') + '</div>';
      }
      db.ref('tickets').orderByChild('createdAt').on('value', function(snap) {
        var list = document.getElementById('ticketsList');
        list.innerHTML = '';
        var tickets = [];
        snap.forEach(function(c) { tickets.push({ id: c.key, v: c.val() }); });
        tickets.reverse();
        tickets.forEach(function(t) {
          var v = t.v;
          var replies = v.replies || {};
          var repliesHtml = '';
          for (var k in replies) {
            var r = replies[k];
            repliesHtml += '<div class="reply ' + (r.isAdmin ? 'admin' : '') + '">' + escapeHtml(r.message || '') + replyAttachmentsHtml(r.attachments) + '</div>';
          }
          var replyInput = '<textarea placeholder="Reply as admin..." class="reply-text" data-tid="' + t.id + '"></textarea>' +
            '<label style="font-size:0.85rem;margin-top:0.5rem;">Attach images (optional)</label>' +
            '<div class="file-btn-wrap">' +
            '<input type="file" class="reply-files file-input" data-tid="' + t.id + '" accept="image/*" multiple>' +
            '<button type="button" class="secondary file-trigger">Choose files</button>' +
            '</div>' +
            '<button type="button" class="reply-btn primary" data-tid="' + t.id + '">Send reply</button>';
          var div = document.createElement('div');
          div.className = 'card';
          div.innerHTML =
            '<div class="ticket-row">' +
              '<div class="ticket-info">' +
                '<strong>' + escapeHtml(v.subject) + '</strong><br>' +
                (v.userEmail || '') + ' · ' + (v.status || 'open') +
              '</div>' +
              '<button type="button" class="danger ticket-delete-btn" data-tid="' + t.id + '">Delete ticket</button>' +
            '</div>' +
            '<div class="ticket-user-profile" data-uid="' + escapeHtml(v.userId || '') + '"><span class="loading">Loading user…</span></div>' +
            '<div class="ticket-detail">' +
              '<p>' + escapeHtml(v.message || '') + '</p>' +
              replyAttachmentsHtml(v.attachments) +
              repliesHtml +
              replyInput +
            '</div>';
          list.appendChild(div);
          var uid = v.userId;
          if (uid) {
            db.ref('users/' + uid).once('value', function(userSnap) {
              var userEl = div.querySelector('.ticket-user-profile');
              if (!userEl) return;
              var u = userSnap.val();
              if (!u) { userEl.innerHTML = '<span class="loading">User not found</span>'; return; }
              var photo = 'https://ui-avatars.com/api/?name=User&background=1e1c24&color=ff4655';
              userEl.innerHTML = '<img src="' + escapeHtml(photo) + '" alt="">' +
                '<div class="profile-info">' +
                  '<strong>' + escapeHtml(u.displayName || u.email || uid) + '</strong>' +
                  (u.email ? '<br>' + escapeHtml(u.email) : '') +
                  (u.valorantName ? '<br>Valorant: ' + escapeHtml(u.valorantName) : '') +
                '</div>';
            });
          } else {
            div.querySelector('.ticket-user-profile').innerHTML = '<span class="loading">No user ID</span>';
          }
        });
        if (tickets.length === 0) list.innerHTML = '<p class="loading">No tickets.</p>';

        list.querySelectorAll('.ticket-delete-btn').forEach(function(btn) {
          btn.onclick = function() {
            var tid = btn.getAttribute('data-tid');
            if (!confirm('Delete this ticket? This cannot be undone.')) return;
            db.ref('tickets/' + tid).remove();
          };
        });
        list.querySelectorAll('.file-trigger').forEach(function(btn) {
          btn.onclick = function() {
            var card = btn.closest('.card');
            var fileInput = card.querySelector('.reply-files');
            if (fileInput) fileInput.click();
          };
        });
        list.querySelectorAll('.reply-btn').forEach(function(btn) {
          btn.onclick = function() {
            var tid = btn.getAttribute('data-tid');
            var textarea = list.querySelector('.reply-text[data-tid="' + tid + '"]');
            var fileInput = list.querySelector('.reply-files[data-tid="' + tid + '"]');
            var msg = textarea.value.trim();
            if (!msg) return;
            var replyData = { message: msg, isAdmin: true, createdAt: firebase.database.ServerValue.TIMESTAMP, attachments: [] };
            db.ref('tickets/' + tid + '/replies').push(replyData).then(function(ref) {
              var replyId = ref.key;
              var files = fileInput ? fileInput.files : [];
              if (files.length === 0) {
                db.ref('tickets/' + tid).update({ status: 'replied' });
                textarea.value = '';
                if (fileInput) fileInput.value = '';
                return;
              }
              var uploads = [];
              var names = [];
              for (var i = 0; i < files.length; i++) {
                if (!files[i].type || files[i].type.indexOf('image') !== 0) continue;
                names.push(files[i].name);
                var path = 'ticketAttachments/admin/' + tid + '/' + replyId + '/' + files[i].name;
                uploads.push(storage.ref(path).put(files[i]).then(function(s) { return s.ref.getDownloadURL(); }));
              }
              Promise.all(uploads).then(function(urls) {
                var att = urls.map(function(url, idx) { return { url: url, name: names[idx] || 'image' }; });
                return db.ref('tickets/' + tid + '/replies/' + replyId).update({ attachments: att });
              }).then(function() {
                db.ref('tickets/' + tid).update({ status: 'replied' });
                textarea.value = '';
                if (fileInput) fileInput.value = '';
              }).catch(function(e) { alert('Upload failed: ' + e.message); });
            });
          };
        });
      });
    }

    function escapeHtml(s) {
      if (!s) return '';
      var d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    checkIp();
  </script>
</body>
</html>
